# 2.1. Manage EC Keys

This chapter introduces how to generate, convert, encode, encrypt, decrypt EC keys using OpenSSL command-line tools.

## Generate EC Keys

According to the key length, there are three types of keys:

```sh
# NIST P-256
openssl ecparam -genkey -name prime256v1 -noout -out es256-raw.pem
# NIST P-384
openssl ecparam -genkey -name secp384r1 -noout -out es384-raw.pem
# NIST P-521
openssl ecparam -genkey -name secp521r1 -noout -out es521-raw.pem
```

However, if you choose to use `curve25519`, you must use the `genpkey` subcommand, and the key must be in PKCS#8 format.

```sh
openssl genpkey -algorithm ed25519 -out ed25519-raw.pem # The generated key file is in PKCS#8 format

openssl genpkey -algorithm x25519 -out x25519-raw.pem # The generated key file is in PKCS#8 format
```

> Note:
>
> - The key is generated without encryption protection.
> - If you want to use `curve25519` in a certificate, please use `ed25519` instead of `x25519`,
>   because the public key in `X.509` certificates is used for signing, not for key exchange.

## Encryption and Decryption of Keys

### Encrypt Keys

```sh
# PKCS#1
openssl ec -aes-256-cfb -in es384-raw.pem -out es384.pem

# PKCS#8
openssl pkcs8 \
    -topk8 \
    -inform PEM \
    -v2 aes256 \
    -in ed25519-p8-raw.pem \
    -out ed25519-p8.pem
```

### Decrypt Keys

```sh
openssl ec -in es384-raw.pem -out es384.pem

# PKCS#8
openssl pkcs8 \
    -inform PEM \
    -in ed25519-p8.pem \
    -out ed25519-p8-raw.pem
```

## Extract Public Key

```sh
# This command accepts both PKCS#1 and PKCS#8 encoded private keys
openssl ec -in es384.pem -pubout -out es384.pub
openssl ec -in ed25519.pem -pubout -out ed25519.pub
```

## View Private Key Information

```sh
# This command accepts both PKCS#1 and PKCS#8 encoded private keys
openssl ec -text -noout -in es384-raw.pem
```

## View Public Key Information

```sh
openssl ec -pubin -text -noout -in es384.pub
openssl ec -pubin -text -noout -in ed25519.pub
```

## Convert Keys

The conversion between EC keys and PKCS#8 is similar to RSA.


> `openssl ec` command accepts `-inform` and `-outform` too, so the DER/PEM conversion of EC keys is the same as RSA keys.

## Test Keys

```sh
openssl rand -out tmp.dat 4096

# Sign the random file with the private key using ECDSA-SHA-256

openssl dgst -sha256 -sign es384-raw.pem -out tmp.dat.sig tmp.dat
openssl dgst -sha256 -verify es384.pub -signature tmp.dat.sig tmp.dat

# Test ECDH (curve25519)

openssl genpkey -algorithm x25519 -out x25519-a.pem
openssl ec -in x25519-a.pem -pubout -out x25519-a.pub

openssl genpkey -algorithm x25519 -out x25519-b.pem
openssl ec -in x25519-b.pem -pubout -out x25519-b.pub

openssl pkeyutl -derive -inkey x25519-a.pem -peerkey x25519-b.pub -out x25519-axb.bin
openssl pkeyutl -derive -inkey x25519-b.pem -peerkey x25519-a.pub -out x25519-bxa.bin

base64 x25519-axb.bin
base64 x25519-bxa.bin

rm x25519-*.*

# Test EdDSA (Ed25519) Signing

openssl genpkey -algorithm ed25519 -out ed25519.pem
openssl ec -in ed25519.pem -pubout -out ed25519.pub

openssl pkeyutl -sign -inkey ed25519.pem -rawin -in tmp.dat -out tmp.dat.sig
openssl pkeyutl -verify -pubin -inkey ed25519.pub -sigfile tmp.dat.sig -rawin -in tmp.dat

rm ed25519.*

rm tmp.*
```

Ok, all above are the common operations of EC keys.
