# 1.1. Manage RSA Keys

This chapter introduces how to generate, convert, encode, encrypt, decrypt RSA keys using OpenSSL command-line tools.

## Generate RSA Private Key

Usually, the `genrsa` subcommand of OpenSSL is used to generate RSA private keys.

For example, to generate an RSA private key file named `rsa-p1-raw.pem`, the configuration is as follows:

Property   | Value
:----------|:----------------
Bits       | `2048`
Cipher     | `AES-256-CFG`
Standard   | `PKCS#1`
Encoding   | `PEM`

```sh
openssl genrsa -aes-256-cfb -out ./rsa-p1.pem 2048
```

> If no encryption algorithm flag is passed (such as `-aes-256-cfb`), a raw private key without encryption protection will be generated.

### Common Parameters

#### `-outform`

Specifies the output file format, which can be either `PEM` or `DER`.

#### `-rand`

Specifies the path to the random seed file used to generate random numbers.

### RSA-PSS

> RSA-PSS is a probabilistic signature padding scheme.
> Compared with the RSA PKCS#1 v1.5 padding scheme commonly used in RSA, it provides better security
> (at the cost of higher computational complexity, i.e., performance loss).

If you need to generate an RSA private key with RSA-PSS signature padding scheme parameters, you can use the following command:

```sh
openssl genpkey \
    -algorithm rsa-pss \
    -pkeyopt rsa_keygen_bits:2048 \
    -pkeyopt rsa_pss_keygen_md:sha256 \
    -pkeyopt rsa_pss_keygen_mgf1_md:sha256 \
    -pkeyopt rsa_pss_keygen_saltlen:32 \
    -out rsa-pss.pem
```

## Standard Conversion

### PKCS#1 -> PKCS#8

```sh
openssl pkcs8 \
    -topk8 \
    -inform PEM \
    -outform PEM \
    -in rsa-p1.pem \
    -out rsa-p8.pem
```

> By default, the `-v2 aes256` parameter is used for encryption. 
> If the converted key does not need encryption protection, add `-nocrypt`, for example:
>
> ```sh
> openssl pkcs8 \
>     -topk8 \
>     -inform PEM \
>     -outform PEM \
>     -nocrypt \
>     -in rsa-p1.pem \
>     -out rsa-p8-raw.pem
> ```

### PKCS#8 -> PKCS#1

```sh
openssl rsa \
    -aes-256-cfb \
    -in rsa-p8.pem \
    -out rsa-p1.pem
```

> If the converted key does not need encryption protection, remove the encryption algorithm flag `-aes-256-cfb`, such as:
>
> ```sh
> openssl rsa \
>     -in rsa-p8.pem \
>     -out rsa-p1-raw.pem
> ```

> By default, both input and output encodings are `PEM`.
> If the input is DER, please specify `-inform DER`. If you need to output DER, please specify `-outform DER`.

## Encoding Conversion

### PKCS#1: PEM <=> DER

e.g. `PEM -> DER`, vice versa

```sh
openssl rsa \
    -inform     PEM \
    -outform    DER \
    -in         rsa-p1-raw.pem \
    -out        rsa-p1-raw.der
```

### PKCS#8: PEM <=> DER

The support for `PKCS#8` DER encoding in OpenSSL is incomplete. Please do not use it.

## Encryption and Decryption

### Encrypt PKCS#1 Private Key

```sh
openssl rsa \
    -inform PEM \
    -aes-256-cfb \
    -in rsa-p1-raw.pem \
    -out rsa-p1.pem
```

### Decrypt PKCS#1 Private Key

```sh
openssl rsa \
    -inform PEM \
    -in rsa-p1.pem \
    -out rsa-p1-raw.pem
```

### Encrypt PKCS#8 Private Key

```sh
openssl pkcs8 \
    -topk8 \
    -inform PEM \
    -v2 aes256 \
    -in rsa-p8-raw.pem \
    -out rsa-p8.pem
```

### Decrypt PKCS#8 Private Key

```sh
openssl pkcs8 \
    -inform PEM \
    -in rsa-p8.pem \
    -out rsa-p8-raw.pem
```

## Extract Public Key

```sh
openssl rsa \
    -inform PEM \
    -in rsa-p1-raw.pem \
    -pubout \
    -out rsa-p1.pub
```

> The `-in` parameter can pass either `PKCS#1` or `PKCS#8` keys.

## View Public Key Information

```sh
openssl rsa \
    -inform PEM \
    -pubin \
    -text \
    -noout \
    -in rsa-p1.pub
```

## View Private Key Information

```sh
openssl rsa \
    -inform PEM \
    -noout \
    -text \
    -in rsa-p1.pem
```

## Test Key

```sh
# Generate a random file for testing
openssl rand -out tmp.dat 4096

# Sign the random file with the private key using RSA-SHA-256
openssl dgst -sha256 -sign rsa-p1.pem -out tmp.dat.sig tmp.dat

# Verify the signature
openssl dgst -sha256 -verify rsa-p1.pub -signature tmp.dat.sig tmp.dat
```

Ok, all above are the common operations of RSA keys.
